name: CI

on:
  pull_request:
    branches: [ main, master ]
  push:
    branches: [ main, master ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.10', '3.11', '3.12']

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y graphviz

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .[dev]

    - name: Run tests with pytest
      run: |
        pytest -v --tb=short

    - name: Run tests with coverage
      if: matrix.python-version == '3.12'
      run: |
        pytest --cov=behaverify --cov-report=xml --cov-report=term

    - name: Upload coverage to Codecov
      if: matrix.python-version == '3.12'
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.xml
        fail_ci_if_error: false
      continue-on-error: true

  examples:
    runs-on: ubuntu-latest
    needs: test

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.12
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y graphviz

    - name: Install BehaVerify
      run: |
        python -m pip install --upgrade pip
        pip install -e .

    - name: Verify BehaVerify installation
      run: |
        python -c "import behaverify; print('BehaVerify imported successfully')"
        behaverify --help

    - name: CLI Test - Generate nuXmv model via CLI
      run: |
        echo "Using CLI: behaverify nuxmv ... --generate"
        behaverify nuxmv \
          test_examples/working/blueROV_mod.tree \
          /tmp/bluerov_cli \
          --generate \
          --recursion_limit 10000 \
          --overwrite
        echo "Generated nuXmv model via CLI:"
        head -50 /tmp/bluerov_cli/nuxmv/blueROV_mod.smv

    - name: CLI Test - Generate LaTeX visualization via CLI
      run: |
        echo "Using CLI: behaverify latex ..."
        behaverify latex \
          test_examples/working/blueROV_mod.tree \
          /tmp/blueROV_mod.tex
        echo "Generated LaTeX file via CLI:"
        head -30 /tmp/blueROV_mod.tex

    - name: CLI Test - Generate Python code via CLI
      run: |
        echo "Using CLI: behaverify python ..."
        behaverify python \
          examples/Collatz/collatz.tree \
          /tmp/collatz_python \
          --max_iter 50 \
          --overwrite
        echo "Generated Python code via CLI:"
        ls -la /tmp/collatz_python/python/
        head -50 /tmp/collatz_python/python/collatz.py

    - name: Verify multiple example models parse correctly
      run: |
        cd src
        for tree_file in ../test_examples/working/*.tree; do
          echo "Checking: $tree_file"
          python check_grammar.py behaverify/data/metamodel/behaverify.tx "$tree_file"
        done
        echo "All working examples parsed successfully!"

  e2e-verification:
    runs-on: ubuntu-latest
    needs: test
    name: End-to-End nuXmv Verification

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.12
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y graphviz wget

    - name: Install BehaVerify
      run: |
        python -m pip install --upgrade pip
        pip install -e .

    - name: Download nuXmv from FBK
      run: |
        # Download nuXmv (per license, we download fresh each time)
        wget -q 'https://nuxmv.fbk.eu/theme/download.php?file=nuXmv-2.1.0-linux64.tar.xz' -O nuXmv.tar.xz
        tar -xf nuXmv.tar.xz
        mv nuXmv-2.1.0-Linux/bin/nuXmv ./nuXmv
        chmod +x ./nuXmv
        ./nuXmv -version
        echo "nuXmv downloaded and ready"

    - name: E2E Test - Collatz via CLI (INVAR specification)
      run: |
        echo "=== Collatz Example - INVAR Verification via CLI ==="
        echo "Using: behaverify nuxmv ... --generate --invar --nuxmv_path"

        # Run full E2E via CLI entry point
        behaverify nuxmv \
          examples/Collatz/collatz.tree \
          /tmp/collatz_output \
          --generate \
          --invar \
          --nuxmv_path ./nuXmv \
          --recursion_limit 10000 \
          --overwrite

        echo "--- Generated SMV model (first 30 lines) ---"
        head -30 /tmp/collatz_output/nuxmv/collatz.smv
        echo "--- Verification Output ---"
        cat /tmp/collatz_output/nuxmv/collatz_output.txt

        # Check that verification completed
        if grep -q "specification" /tmp/collatz_output/nuxmv/collatz_output.txt; then
          echo "✓ INVAR verification completed successfully via CLI"
        else
          echo "Warning: Could not confirm INVAR verification completed"
          exit 1
        fi

    - name: E2E Test - DrunkenDrone via CLI (CTL specification)
      run: |
        echo "=== DrunkenDrone Example - CTL Verification via CLI ==="
        echo "Using: behaverify nuxmv ... --generate --ctl --nuxmv_path"

        # Run full E2E via CLI entry point
        behaverify nuxmv \
          examples/DrunkenDrone/DrunkenDrone.tree \
          /tmp/drone_output \
          --generate \
          --ctl \
          --nuxmv_path ./nuXmv \
          --recursion_limit 10000 \
          --overwrite

        echo "--- Generated SMV model (first 30 lines) ---"
        head -30 /tmp/drone_output/nuxmv/DrunkenDrone.smv
        echo "--- Verification Output ---"
        cat /tmp/drone_output/nuxmv/DrunkenDrone_output.txt

        # Check that verification completed
        if grep -q "specification" /tmp/drone_output/nuxmv/DrunkenDrone_output.txt; then
          echo "✓ CTL verification completed successfully via CLI"
        else
          echo "Warning: Could not confirm CTL verification completed"
          exit 1
        fi

    - name: E2E Test - blueROV_mod via CLI (INVAR specification)
      run: |
        echo "=== blueROV_mod Example - INVAR Verification via CLI ==="
        echo "Using: behaverify nuxmv ... --generate --invar --nuxmv_path"

        # Run full E2E via CLI entry point
        behaverify nuxmv \
          test_examples/working/blueROV_mod.tree \
          /tmp/bluerov_output \
          --generate \
          --invar \
          --nuxmv_path ./nuXmv \
          --recursion_limit 10000 \
          --overwrite

        echo "--- Generated SMV model (first 30 lines) ---"
        head -30 /tmp/bluerov_output/nuxmv/blueROV_mod.smv
        echo "--- Verification Output ---"
        cat /tmp/bluerov_output/nuxmv/blueROV_mod_output.txt

        # Check that verification completed
        if grep -q "specification" /tmp/bluerov_output/nuxmv/blueROV_mod_output.txt; then
          echo "✓ INVAR verification completed successfully via CLI"
        else
          echo "Warning: Could not confirm INVAR verification completed"
          exit 1
        fi

    - name: Summary of E2E Tests
      run: |
        echo "========================================"
        echo "End-to-End Verification Summary (via CLI)"
        echo "========================================"
        echo "All tests used the main 'behaverify' CLI entry point"
        echo ""
        echo "1. Collatz (INVAR): behaverify nuxmv --generate --invar"
        echo "2. DrunkenDrone (CTL): behaverify nuxmv --generate --ctl"
        echo "3. blueROV_mod (INVAR): behaverify nuxmv --generate --invar"
        echo "========================================"
        echo "All end-to-end nuXmv verifications passed via CLI!"

  lint:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.12
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Install linting tools
      run: |
        python -m pip install --upgrade pip
        pip install flake8

    - name: Lint with flake8
      run: |
        # Stop build on syntax errors or undefined names
        flake8 src/behaverify --count --select=E9,F63,F7,F82 --show-source --statistics
        # Warnings for other issues (non-blocking)
        flake8 src/behaverify --count --exit-zero --max-complexity=15 --max-line-length=150 --statistics
